From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spliterash <me@spliterash.ru>
Date: Wed, 21 Dec 2022 23:48:35 +0300
Subject: [PATCH] Kotlin MC Init


diff --git a/build.gradle.kts b/build.gradle.kts
index 5114682866b2645aaa7517416857792c33aeb3f9..8af30e895b599d250f87513361fd27f7dbd5d7d2 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -2,7 +2,6 @@ import io.papermc.paperweight.util.*
 
 plugins {
     java
-    kotlin("jvm") version "1.7.21" // Kotlin version to use
     `maven-publish`
     id("com.github.johnrengelman.shadow")
 }
@@ -14,12 +13,6 @@ dependencies {
         exclude("io.papermc.paper", "paper-api")
     }
     // Pufferfish end
-    // Minetopia start
-    // https://mvnrepository.com/artifact/org.jetbrains.kotlinx/kotlinx-coroutines-core
-    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.6.4")
-    implementation("com.github.luben:zstd-jni:1.4.4-2")
-    implementation("org.lz4:lz4-java:1.8.0")
-    // Minetopia end
     // Paper start
     implementation("org.jline:jline-terminal-jansi:3.21.0")
     implementation("net.minecrell:terminalconsoleappender:1.3.0")
diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index 5c54a5da7fb50cd97799c5fa280a24d5c6117244..05d1ef1392ae0353bb51b43d19ee2903ec47744a 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -55,6 +55,7 @@ import net.minecraft.world.level.GameRules;
 import net.minecraft.world.level.GameType;
 import net.minecraft.world.level.block.entity.SkullBlockEntity;
 import net.minecraft.world.level.storage.LevelStorageSource;
+import org.bukkit.craftbukkit.scheduler.MinecraftInternalPlugin;
 import org.slf4j.Logger;
 
 // CraftBukkit start
@@ -67,6 +68,7 @@ import co.aikar.timings.MinecraftTimings; // Paper
 import org.bukkit.event.server.ServerCommandEvent;
 import org.bukkit.craftbukkit.util.Waitable;
 import org.bukkit.event.server.RemoteServerCommandEvent;
+import ru.spliterash.kotlinmc.KotlinMCInitializer;
 // CraftBukkit end
 
 public class DedicatedServer extends MinecraftServer implements ServerInterface {
@@ -341,6 +343,7 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
             }
 
             if (gg.pufferfish.pufferfish.PufferfishConfig.enableAsyncMobSpawning) mobSpawnExecutor.start(); // Pufferfish
+            KotlinMCInitializer.INSTANCE.init(new MinecraftInternalPlugin());
             return true;
         }
     }
diff --git a/src/main/java/net/minecraft/world/level/chunk/storage/RegionFileSaver.kt b/src/main/java/net/minecraft/world/level/chunk/storage/RegionFileSaver.kt
index 32e8c646afef345986608277aa8073f445431084..b48dfdf15a88b015bb3134ce9083323eeed6cd14 100644
--- a/src/main/java/net/minecraft/world/level/chunk/storage/RegionFileSaver.kt
+++ b/src/main/java/net/minecraft/world/level/chunk/storage/RegionFileSaver.kt
@@ -44,18 +44,20 @@ class RegionFileSaver(private val regionFile: RegionFile) {
                 try {
                     delay(10000)
                 } catch (ex: CancellationException) {
-                    save()
+                    save(true)
                     break
                 }
             }
         }
     }
 
-    suspend fun save() {
+    suspend fun save(removeMutex: Boolean = false) {
         val mutex = GLOBAL_LOCK.computeIfAbsent(regionFile.regionFile) { Mutex() }
 
         mutex.withLock {
             regionFile.realFlush()
+            if (removeMutex)
+                GLOBAL_LOCK.remove(regionFile.regionFile)
         }
     }
 
